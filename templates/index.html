<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIT CHECK MIRROR</title>
    <link rel="icon" type="image/x-icon" href="/static/fitcheckmirror_icon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/mobile.css?v=29" media="(max-width: 600px)">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        :root {
            --paper-white: #fdfbf7;
            --ink-black: #2c2c2c;
            --sticky-yellow: #fff740;
            --highlight-blue: #a8dadc;
        }

        body {
            background: url('/static/background_image.jpg') no-repeat center center fixed;
            background-size: cover;
            color: var(--ink-black);
            font-family: 'Patrick Hand', cursive;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            /* Fallback */
            height: 100dvh;
            /* Mobile Browser Fix */
            overflow: hidden;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0px #fff;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px 20px;
            border-radius: 10px;
            border: 3px solid var(--ink-black);
            transform: rotate(-2deg);
        }

        .container {
            position: relative;
            width: 100%;
            max-width: 800px;
            background: var(--paper-white);
            border: 4px solid var(--ink-black);
            box-shadow: 10px 10px 0px rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 5px;
        }

        /* Mock Paper Lines */
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 40px;
            height: 100%;
            width: 2px;
            background: #ff9999;
            z-index: 0;
        }

        .video-wrapper {
            position: relative;
            z-index: 1;
            border: 3px solid var(--ink-black);
            background: #000 url('/static/mirror_image.png') no-repeat center center;
            background-size: cover;
            width: 100%;
            height: 500px;
            /* Fixed Constant Height */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: row;
            /* Side by side */
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.4);
            /* Slight transparency to see mirror */
            z-index: 15;
            gap: 40px;
        }

        .start-btn {
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid var(--ink-black);
            width: 180px;
            height: 180px;
            /* Square/Box shape */
            font-size: 1.5rem;
            font-family: 'Patrick Hand', cursive;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 10px 10px 0px var(--sticky-yellow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            text-align: center;
            transition: all 0.2s;
        }

        .start-btn:hover {
            transform: translate(-3px, -3px) rotate(2deg);
            box-shadow: 15px 15px 0px var(--sticky-yellow);
            background: #fff;
        }

        .start-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 5px 5px 0px var(--sticky-yellow);
        }

        /* Upload Preview Image */
        #previewImage {
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* Fit inside the fixed mirror box */
            display: none;
            transform: scaleX(1);
            /* No mirror for uploads */
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transform: scaleX(-1);
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: var(--sticky-yellow);
            box-shadow: 0 0 10px var(--sticky-yellow);
            opacity: 0;
            pointer-events: none;
            z-index: 2;
        }

        .scanning .scan-line {
            opacity: 1;
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0% {
                top: 0%;
            }

            50% {
                top: 100%;
            }

            100% {
                top: 0%;
            }
        }

        .controls {
            margin-top: 25px;
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
            z-index: 2;
        }

        /* Sticky Note Buttons */
        button,
        select {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.3rem;
            font-weight: bold;
            border: 3px solid var(--ink-black);
            background: var(--sticky-yellow);
            color: var(--ink-black);
            padding: 10px 20px;
            cursor: pointer;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            text-transform: uppercase;
        }

        /* Specific Select Styling for Custom Arrow */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%232c2c2c%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 15px top 50%;
            background-size: 16px auto;
            padding-right: 40px;
        }

        button:hover,
        select:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.2);
        }

        .vibe-select {
            background-color: #fff;
            /* Ensure white background for contrast */
            transform: rotate(-1deg);
        }

        #timerSelector {
            width: auto;
            min-width: 160px;
            /* Force minimum width */
            text-align: center;
            box-sizing: border-box;
            transform: rotate(2deg);
            flex-shrink: 0;
            /* Prevent shrinking */
        }

        #scanBtn {
            background: #ff7eb3;
            /* Pop of color */
            color: white;
            text-shadow: 1px 1px 0 #000;
            transform: rotate(1deg);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        /* Overlay Styles Adapted */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        .overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .score-label {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--ink-black);
            margin-bottom: 10px;
            text-transform: uppercase;
            text-decoration: underline;
            text-decoration-style: wavy;
            text-decoration-color: var(--highlight-blue);
            transform: rotate(-2deg);
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border: 4px solid var(--ink-black);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            background: var(--sticky-yellow);
            box-shadow: 5px 5px 0px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .roast-text {
            font-size: 1.5rem;
            text-align: center;
            padding: 10px;
            max-width: 80%;
            font-weight: bold;
            color: var(--ink-black);
            text-shadow: none;
            max-height: 120px;
            /* Safety cap restoration */
            overflow-y: auto;
        }

        .tips-container {
            border: 3px dashed var(--ink-black);
            background: #e0f7fa;
            padding: 15px;
            margin: 20px 0;
            max-width: 80%;
            transform: rotate(-1deg);
            box-shadow: 3px 3px 0px rgba(0, 0, 0, 0.1);
            max-height: 100px;
            /* Safety cap restoration */
            overflow-y: auto;
        }

        .tips-title {
            color: #007bb5;
            font-weight: bold;
            font-size: 1.1rem;
            text-decoration: underline;
        }

        .tips-text {
            color: var(--ink-black);
            font-size: 1.2rem;
        }

        .countdown-overlay {
            font-size: 8rem;
            color: var(--ink-black);
            text-shadow: 4px 4px 0px #fff;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            display: none;
        }

        .loading-text {
            font-size: 2rem;
            color: var(--sticky-yellow);
            text-shadow: 2px 2px 0px #000;
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 21;
            display: none;
            font-weight: bold;
        }

        .stable-msg {
            font-size: 1.5rem;
            color: #d32f2f;
            background: #fff;
            border: 3px solid #d32f2f;
            padding: 10px 20px;
            font-weight: bold;
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 21;
            display: none;
            box-shadow: 5px 5px 0px rgba(0, 0, 0, 0.2);
            transform: translate(-50%, -50%) rotate(-2deg);
        }

        /* Hide raw canvas */
        #canvas {
            display: none;
        }

        .comic-alert {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            /* Dark overlay */
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .comic-alert-box {
            background: #fff;
            border: 4px solid var(--ink-black);
            padding: 30px;
            max-width: 400px;
            text-align: center;
            transform: rotate(-2deg);
            box-shadow: 15px 15px 0px var(--sticky-yellow);
            position: relative;
        }

        .comic-alert-title {
            font-size: 2rem;
            color: #d32f2f;
            margin-bottom: 15px;
            text-transform: uppercase;
            text-shadow: 2px 2px 0px #000;
        }

        .comic-alert-text {
            font-size: 1.5rem;
            margin-bottom: 25px;
            font-weight: bold;
        }

        .comic-btn {
            background: var(--highlight-blue);
            border: 3px solid var(--ink-black);
            padding: 10px 25px;
            font-size: 1.2rem;
            font-family: 'Patrick Hand', cursive;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 5px 5px 0px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
        }

        .comic-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 7px 7px 0px rgba(0, 0, 0, 0.2);
        }

        .comic-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.2);
        }

        /* Custom Dropdown Base Styles (Desktop & Mobile Base) */
        .custom-vibe-wrapper {
            position: relative;
            width: 300px;
            /* Desktop width */
            font-family: 'Patrick Hand', cursive;
        }

        .custom-vibe-trigger {
            background: #fff;
            border: 3px solid var(--ink-black);
            padding: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 5px 5px 0px rgba(0, 0, 0, 0.2);
            font-weight: bold;
        }

        .custom-vibe-options {
            position: absolute;
            top: 100%;
            /* Downwards on desktop */
            left: 0;
            width: 100%;
            background: #fff;
            border: 3px solid var(--ink-black);
            display: none;
            /* Hidden */
            flex-direction: column;
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
        }

        .custom-vibe-options.show {
            display: flex;
        }

        .custom-option {
            padding: 10px;
            border-bottom: 2px solid #eee;
            cursor: pointer;
            font-weight: bold;
        }

        .custom-option:hover {
            background: #f0f0f0;
        }

        /* Desktop Fix: Unwrap the groups so grid/flex works as before */
        .res-header,
        .res-body {
            display: contents;
        }

        /* Responsive Visibility Toggles */
        @media (min-width: 601px) {
            .mobile-only {
                display: none !important;
            }

            .desktop-only {
                display: block !important;
            }
        }

        @media (max-width: 600px) {
            .mobile-only {
                display: flex !important;
            }

            .desktop-only {
                display: none !important;
            }
        }

        /* Wrapper for scaling UI content independently of background */
        .ui-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        @media (min-width: 601px) {
            .ui-wrapper {
                zoom: 0.8;
                /* Scale down to 80% for laptops */
            }

            /* Ensure mobile popups are hidden on desktop (except info popup) */
            .mobile-popup-overlay:not(#infoPopup) {
                display: none !important;
            }

            /* Hide Camera Switch on Desktop */
            #cameraSwitchBtn {
                display: none !important;
            }
        }

        /* Camera Switch Button */
        #cameraSwitchBtn {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 20;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid var(--ink-black);
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: none;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body style="opacity: 0; animation: fadeInPage 0.5s forwards;">
    <!-- Page Fade In Animation -->
    <style>
        @keyframes fadeInPage {
            to {
                opacity: 1;
            }
        }
    </style>

    <!-- Push button feel for login button -->
    <style>
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border-left-color: #000;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #loginBtn {
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        #loginBtn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.3);
        }

        #loginBtn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.3);
        }

        /* Push button feel for scan button */
        #scanBtn {
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        #scanBtn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.3);
        }

        #scanBtn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.3);
        }

        /* Push button feel for info button */
        #infoBtnDesktop:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.3);
        }

        #infoBtnDesktop:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.3);
        }
    </style>

    <div class="user-controls" id="userControls"
        style="position: fixed; top: 10px; right: 10px; z-index: 1000; font-family: 'Patrick Hand', cursive; display: flex; gap: 10px; align-items: center;">

        <!-- Info Button (Desktop - next to login) -->
        <button id="infoBtnDesktop" class="desktop-only"
            onclick="document.getElementById('infoPopup').style.display='flex'"
            style="width: 45px; height: 45px; border-radius: 50%; background: white; border: 3px solid black; box-shadow: 4px 4px 0px rgba(0,0,0,0.3); font-size: 1.6rem; font-weight: bold; font-style: italic; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.1s, box-shadow 0.1s; padding: 0; line-height: 1; font-family: Georgia, serif; text-transform: none;">
            i
        </button>

        <!-- Login Button -->
        <button id="loginBtn" class="comic-btn" onclick="signInWithGoogle()"
            style="display: none; font-size: 1rem; padding: 10px 20px; cursor: pointer; min-width: 120px;">
            <span class="desktop-text">G SIGN IN</span>
            <span class="mobile-icon" style="display:none;">G</span>
            <span class="mobile-text" style="display:none;">sign in</span>
        </button>
        <div id="userProfile"
            style="display: none; align-items: center; gap: 10px; background: white; padding: 5px 15px 5px 5px; border: 3px solid black; box-shadow: 4px 4px 0px black; cursor: pointer;"
            <div id="userProfile"
            style="display: none; align-items: center; gap: 10px; background: white; padding: 5px 15px 5px 5px; border: 3px solid black; box-shadow: 4px 4px 0px black; cursor: pointer;"
            onclick="navigateToProfile()">

            <!-- Desktop View -->
            <div class="desktop-profile" style="display: flex; align-items: center; gap: 10px;">
                <div id="profileLoadingSpinner" class="spinner"
                    style="display: none; width: 20px; height: 20px; border-width: 2px;"></div>
                <img id="userAvatar" src=""
                    style="width: 30px; height: 30px; border-radius: 50%; border: 2px solid black;">
                <a id="profileLink" href="#" style="text-decoration: none; color: black; font-weight: bold;">MY
                    PROFILE</a>
            </div>

            <!-- Mobile View (Compact) -->
            <div class="mobile-profile-icon"
                style="display: none; flex-direction: column; align-items: center; justify-content: center; line-height: 1;">
                <div id="mobileProfileSpinner" class="spinner"
                    style="display: none; width: 24px; height: 24px; border-width: 3px; margin-bottom: 5px;"></div>
                <span id="mobileProfileIcon" style="font-size: 1.5rem;">üë§</span>
                <span id="mobileProfileText"
                    style="font-size: 0.6rem; font-weight: bold; text-transform: uppercase;">YOU</span>
            </div>
        </div>
    </div>

    <!-- Info Button (Mobile Only - Top Left) -->
    <button id="infoBtn" class="mobile-only" onclick="document.getElementById('infoPopup').style.display='flex'"
        style="position: fixed; top: 10px; left: 10px; z-index: 1000; width: 45px; height: 45px; border-radius: 50%; background: white; border: 3px solid black; box-shadow: 3px 3px 0px rgba(0,0,0,0.3); font-size: 1.5rem; font-weight: bold; cursor: pointer; display: none;">
        ‚ÑπÔ∏è
    </button>

    <!-- Info Popup Modal -->
    <div id="infoPopup" class="mobile-popup-overlay"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center;">
        <div id="infoPopupContent"
            style="background: white; border: 4px solid black; padding: 20px; width: 90%; max-width: 350px; max-height: 80vh; overflow-y: auto; box-shadow: 10px 10px 0px rgba(0,0,0,0.3); position: relative; margin: auto;">

            <!-- Close Button (Fixed centering) -->
            <button onclick="document.getElementById('infoPopup').style.display='none'"
                style="position: absolute; top: 8px; right: 8px; background: #FF3B30; color: white; border: 2px solid black; width: 32px; height: 32px; border-radius: 50%; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1;">‚úï</button>

            <h2 style="text-align: center; margin-top: 0; font-size: 1.8rem; text-transform: uppercase;">‚ú® FIT CHECK
                MIRROR ‚ú®</h2>

            <p style="text-align: center; font-size: 1.1rem; margin-bottom: 20px;">Your AI-Powered Fashion Critic! üî•
            </p>

            <div style="text-align: left; font-size: 1rem; line-height: 1.6;">
                <p><strong>üì∏ SNAP OR UPLOAD</strong><br>Use your camera or upload a pic of your outfit!</p>

                <p><strong>üéØ GET YOUR DRIP SCORE</strong><br>Our AI rates your fit from 0-100. Will you be roasted or
                    hyped?</p>

                <p><strong>üíæ SAVE & TRACK</strong><br>Sign in to save your scores and build your drip history!</p>

                <p><strong>üîó SHARE YOUR CARD</strong><br>Flex your score with a shareable drip card!</p>

                <p><strong>üí° STYLE AUDIT</strong><br>Get personalized tips to level up your fashion game!</p>

                <p><strong>üë§ PUBLIC PROFILE</strong><br>Show off your stats - Total Fits, Peak Drip, Average Rating!
                </p>
            </div>

            <p style="text-align: center; font-size: 0.9rem; margin-top: 15px; color: #666;">
                <strong>üìß CONTACT:</strong> <a href="mailto:kavishbishnoi19@gmail.com"
                    style="color: #007AFF;">kavishbishnoi19@gmail.com</a>
            </p>

            <button onclick="document.getElementById('infoPopup').style.display='none'"
                style="width: 100%; margin-top: 15px; background: #007AFF; color: white; padding: 12px; font-size: 1.2rem;">
                LET'S GO! üöÄ
            </button>
        </div>
    </div>

    <div class="ui-wrapper">
        <h1>FIT CHECK MIRROR</h1>

        <div class="container">
            <div class="video-wrapper" id="camera-container">
                <!-- Camera Switch Button (Mobile Only) -->
                <button id="cameraSwitchBtn" onclick="switchCamera()">üîÑ</button>

                <!-- Back Button (Go back to start screen) -->
                <button id="backToStartBtn" onclick="resetApp()"
                    style="position: absolute; top: 15px; left: 15px; z-index: 20; background: rgba(255, 255, 255, 0.8); border: 2px solid black; width: 38px; height: 38px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.2);">
                    ‚Ü©Ô∏è
                </button>

                <!-- Start Screen Overlay -->
                <div id="startScreen" class="start-screen">
                    <button class="start-btn" onclick="triggerUpload()">
                        <span style="font-size: 3rem;">üìÅ</span>
                        UPLOAD PIC
                    </button>
                    <button class="start-btn" onclick="initCamera()">
                        <span style="font-size: 3rem;">üì∑</span>
                        USE MIRROR
                    </button>
                </div>

                <video id="video" autoplay playsinline></video>
                <img id="previewImage" alt="Uploaded Outfit">
                <input type="file" id="fileInput" accept="image/*" hidden onchange="handleFileUpload(this)">

                <div class="scan-line" id="scanLine"></div>
                <div class="countdown-overlay" id="countdownOverlay">3</div>

                <div class="loading-text" id="loadingText">ANALYZING DRIP...</div>
                <div class="stable-msg" id="stableMsg">‚ö† HOLD STILL FOR SCAN ‚ö†</div>

                <div class="overlay" id="resultOverlay">
                    <div class="res-header">
                        <div class="score-label">‚ú® DRIP SCORE ‚ú®</div>
                        <div class="score-circle" id="score">0</div>
                        <div style="font-size: 2rem; margin-bottom: 10px;" id="emojiDisplay"></div>
                    </div>

                    <div class="res-body">
                        <div class="roast-text" id="roast">"Analyzing..."</div>

                        <div class="tips-container">
                            <div class="tips-title">üí° STYLE AUDIT:</div>
                            <div class="tips-text" id="tipsText">Loading...</div>
                        </div>
                    </div>

                    <div class="row"
                        style="display:flex; gap:10px; width:100%; justify-content:center; flex-wrap: wrap;">
                        <button class="comic-btn" onclick="resetApp()"
                            style="background:var(--highlight-blue); flex:1; min-width: 100px;">TRY AGAIN üîÑ</button>
                        <button class="comic-btn" onclick="generateShareCard()"
                            style="background:var(--sticky-yellow); flex:1; min-width: 100px;">SHARE üì§</button>
                        <button id="saveScoreBtn" class="comic-btn" onclick="saveScore()"
                            style="background:#4CD964; flex:1; min-width: 100px; display: none;">SAVE DRIP ÔøΩ</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <!-- Desktop Dropdowns -->
            <select id="vibeSelector" class="vibe-select desktop-only">
                <option value="">‚ú® SELECT VIBE ‚ú®</option>
                <option value="Casual Wear">üß¢ Daily Edit (Casual)</option>
                <option value="Office Wear">üíº Boardroom (Formal)</option>
                <option value="Party Wear">ü•Ç Evening Edit (Party)</option>
                <option value="Street Style">üõπ Urban Pulse (Street)</option>
                <option value="Traditional Wear">üëò Heritage (Traditional)</option>
                <option value="Sportswear">üèÉ In Motion (Sports)</option>
            </select>

            <select id="timerSelector" class="desktop-only">
                <option value="3">3s</option>
                <option value="5">5s</option>
                <option value="10">10s</option>
            </select>

            <!-- Mobile Popup Buttons -->
            <button id="mobileVibeBtn" class="mobile-popup-btn mobile-only" onclick="openVibePopup()">
                <span id="mobileVibeText">‚ú® SELECT VIBE ‚ú®</span>
            </button>
            <button id="mobileTimerBtn" class="mobile-popup-btn mobile-only" onclick="openTimerPopup()">
                <span id="mobileTimerText">3s</span>
            </button>

            <button id="scanBtn" onclick="scanOutfit()">SCAN OUTFIT</button>
        </div>
    </div> <!-- End of ui-wrapper -->


    <!-- Mobile Vibe Popup -->
    <div id="vibePopup" class="mobile-popup-overlay" onclick="closeVibePopup()">
        <div class="mobile-popup-box" onclick="event.stopPropagation()">
            <div class="mobile-popup-title">SELECT YOUR VIBE</div>
            <div class="mobile-popup-options">
                <div class="mobile-popup-option" onclick="selectMobileVibe('Casual Wear', 'üß¢ Daily Edit (Casual)')">üß¢
                    Daily Edit (Casual)</div>
                <div class="mobile-popup-option" onclick="selectMobileVibe('Office Wear', 'üíº Boardroom (Formal)')">üíº
                    Boardroom (Formal)</div>
                <div class="mobile-popup-option" onclick="selectMobileVibe('Party Wear', 'ü•Ç Evening Edit (Party)')">ü•Ç
                    Evening Edit (Party)</div>
                <div class="mobile-popup-option" onclick="selectMobileVibe('Street Style', 'üõπ Urban Pulse (Street)')">
                    üõπ Urban Pulse (Street)</div>
                <div class="mobile-popup-option"
                    onclick="selectMobileVibe('Traditional Wear', 'üëò Heritage (Traditional)')">üëò Heritage
                    (Traditional)</div>
                <div class="mobile-popup-option" onclick="selectMobileVibe('Sportswear', 'üèÉ In Motion (Sports)')">üèÉ In
                    Motion (Sports)</div>
            </div>
        </div>
    </div>

    <!-- Mobile Timer Popup -->
    <div id="timerPopup" class="mobile-popup-overlay" onclick="closeTimerPopup()">
        <div class="mobile-popup-box" onclick="event.stopPropagation()">
            <div class="mobile-popup-title">SELECT TIMER</div>
            <div class="mobile-popup-options">
                <div class="mobile-popup-option" onclick="selectMobileTimer('3', '3s')">3 seconds</div>
                <div class="mobile-popup-option" onclick="selectMobileTimer('5', '5s')">5 seconds</div>
                <div class="mobile-popup-option" onclick="selectMobileTimer('10', '10s')">10 seconds</div>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlert" class="comic-alert">
        <div class="comic-alert-box">
            <div class="comic-alert-title">‚ö†Ô∏è WAIT A SEC! ‚ö†Ô∏è</div>
            <div class="comic-alert-text">TELL THE MIRROR WHAT YOU'RE WEARING SO WE CAN JUDGE YOU FAIRLY!</div>
            <div style="display: flex; gap: 10px; width: 100%; justify-content: center;">
                <button class="comic-btn" id="mainAlertBtn" onclick="closeAlert()">OK, MY BAD</button>
                <button class="comic-btn" id="secondaryAlertBtn"
                    style="display:none; background: #FF9500; color: white;">SURE</button>
            </div>
        </div>
    </div>

    <!-- Username Setup Modal -->
    <div id="usernameModal" class="comic-alert" style="display:none; z-index:2000;">
        <div class="comic-alert-box">
            <div class="comic-alert-title">WHO DIS? üëÄ</div>
            <div class="comic-alert-text">Pick a unique username for your Drip Profile!</div>
            <input type="text" id="usernameInput" placeholder="drip_king_99"
                style="font-size: 1.5rem; padding: 10px; border: 3px solid black; width: 80%; margin-bottom: 20px; font-family: inherit; text-transform: lowercase;">
            <div id="usernameError" style="color: red; font-weight: bold; display: none; margin-bottom: 10px;">Username
                taken!</div>
            <button class="comic-btn" onclick="submitUsername()">CLAIM IT</button>
        </div>
    </div>

    <!-- Hidden Canvas for Capture -->
    <canvas id="canvas" style="display:none;"></canvas>
    <script src="/static/share.js"></script>
    <script>
        // --- FIREBASE CONFIGURATION ---
        // Loaded from .env via Flask
        const firebaseConfig = {
            apiKey: "{{ firebase_config.apiKey }}",
            authDomain: "{{ firebase_config.authDomain }}",
            projectId: "{{ firebase_config.projectId }}",
            storageBucket: "{{ firebase_config.storageBucket }}",
            messagingSenderId: "{{ firebase_config.messagingSenderId }}",
            appId: "{{ firebase_config.appId }}"
        };

        let currentUser = null;
        let authToken = null;

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const provider = new firebase.auth.GoogleAuthProvider();

            // Login Function
            window.signInWithGoogle = () => {
                auth.signInWithPopup(provider).catch(error => {
                    console.error("Login Failed:", error);
                    if (error.code === 'auth/popup-closed-by-user' || error.code === 'auth/cancelled-popup-request') {
                        // User closed the popup OR clicked twice/conflicted. No need to alert.
                        return;
                    }
                    showCustomAlert("LOGIN FAILED: " + error.message, "LOGIN ERROR üõë", "TRY AGAIN");
                });
            };

            // Auth State Listener
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log("Logged in:", user.displayName);
                    currentUser = user;
                    authToken = await user.getIdToken();

                    // Update UI (Show Loading State Initially)
                    document.getElementById('loginBtn').style.display = 'none';
                    document.getElementById('userProfile').style.display = 'flex';
                    document.getElementById('userAvatar').src = user.photoURL;
                    setProfileLoading(true); // START LOADING SPINNER

                    // Sync with Backend
                    syncUserWithBackend(authToken);
                } else {
                    console.log("Logged out");
                    currentUser = null;
                    authToken = null;
                    document.getElementById('loginBtn').style.display = 'block';
                    document.getElementById('userProfile').style.display = 'none';
                }
            });

            async function syncUserWithBackend(token, retryCount = 0) {
                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ idToken: token })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.warn("Backend Sync Failed:", errorData);

                        // CLOCK SKEW FIX: Retry after a delay if error is likely 401/400
                        if ((retryCount || 0) < 3) {
                            console.log(`Retrying sync in 2s (Attempt ${(retryCount || 0) + 1})...`);
                            setTimeout(() => syncUserWithBackend(token, (retryCount || 0) + 1), 2000);
                        }
                        return;
                    }
                    const data = await response.json();

                    if (data.status === 'new_user' || !data.username) {
                        // Show username setup modal if no username
                        document.getElementById('usernameModal').style.display = 'flex';
                    } else {
                        // Update Profile Link
                        document.getElementById('profileLink').href = '/u/' + data.username;
                        setProfileLoading(false); // STOP LOADING SPINNER (Ready!)
                    }
                } catch (e) {
                    console.error("Backend Sync Error:", e);
                }
            }

            // Fix for Back Button Navigation (BFCache):
            // Forces a re-sync whenever the page is shown (persisted or nav).
            window.addEventListener('pageshow', async (event) => {
                // Try to get fresh token if user is initialized
                const user = auth.currentUser;
                if (user) {
                    console.log("Page shown (user detected), re-syncing...");
                    const token = await user.getIdToken();
                    syncUserWithBackend(token);
                } else if (authToken) {
                    console.log("Page shown (token detected), re-syncing...");
                    syncUserWithBackend(authToken);
                }
            });

            window.submitUsername = async () => {
                const input = document.getElementById('usernameInput');
                const errorDiv = document.getElementById('usernameError');
                const username = input.value.trim().toLowerCase();

                if (username.length < 3) {
                    errorDiv.textContent = "Too short (3+ chars)";
                    errorDiv.style.display = 'block';
                    return;
                }

                try {
                    const response = await fetch('/api/set-username', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ idToken: authToken, username: username })
                    });
                    const data = await response.json();

                    if (data.status === 'success') {
                        document.getElementById('usernameModal').style.display = 'none';
                        document.getElementById('profileLink').href = '/u/' + username;
                        setProfileLoading(false); // STOP SPINNER (New User Ready!)
                        showCustomAlert("WELCOME TO THE CLUB, " + username.toUpperCase() + "! üéâ", "OFFICIAL DRIP ‚úÖ", "LET'S GO");
                    } else {
                        errorDiv.textContent = data.error || "Username taken";
                        errorDiv.style.display = 'block';
                    }
                } catch (e) {
                    errorDiv.textContent = "Network Error";
                    errorDiv.style.display = 'block';
                }
            };

        } catch (e) {
            console.error("Firebase Init Error (Check Config):", e);
        }

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const scanBtn = document.getElementById('scanBtn');
        const scanLine = document.getElementById('scanLine');
        const resultOverlay = document.getElementById('resultOverlay');
        const scoreEl = document.getElementById('score');
        const roastEl = document.getElementById('roast');
        const loadingText = document.getElementById('loadingText');
        const videoContainer = document.getElementById('camera-container');
        const customAlert = document.getElementById('customAlert');
        const startScreen = document.getElementById('startScreen');
        const previewImage = document.getElementById('previewImage');
        const fileInput = document.getElementById('fileInput');

        let uploadedFile = null;
        let scannedImageDataUrl = null; // Store the scanned image for share card
        let currentAudio = null; // Track audio to stop it on reset

        let currentFacingMode = 'environment'; // Default to rear camera

        // Camera Initialization (Manual)
        async function initCamera() {
            startScreen.style.display = 'none';
            video.style.display = 'block';
            previewImage.style.display = 'none';
            uploadedFile = null; // Clear any old upload

            // Show switch button on mobile, back button on all devices
            if (window.innerWidth <= 600) {
                document.getElementById('cameraSwitchBtn').style.display = 'flex';
            }
            document.getElementById('backToStartBtn').style.display = 'flex';

            try {
                // improved constraints for mobile rear camera
                const constraints = {
                    video: {
                        facingMode: currentFacingMode
                    }
                };

                // Stop any existing tracks first
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
            } catch (err) {
                console.error("Camera Error:", err);
                alert("Could not access camera: " + err.name);
                resetApp(); // Go back to start
            }
        }

        async function switchCamera() {
            // Toggle Mode
            currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';

            // Re-Initialize with new mode
            await initCamera();
        }

        // Upload Logic
        function triggerUpload() {
            fileInput.click();
        }

        function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                uploadedFile = input.files[0];

                // Show Image
                const reader = new FileReader();
                reader.onload = function (e) {
                    previewImage.src = e.target.result;
                    startScreen.style.display = 'none';
                    video.style.display = 'none'; // Hide video
                    previewImage.style.display = 'block'; // Show image

                    // Show back button
                    document.getElementById('backToStartBtn').style.display = 'flex';

                    // Do NOT auto-scan. User must click "SCAN OUTFIT" manually.
                }
                reader.readAsDataURL(uploadedFile);
            }
        }

        // MODIFIED: Custom Alert with Optional Secondary Button
        function showCustomAlert(message, title = '‚ö†Ô∏è WAIT A SEC! ‚ö†Ô∏è', buttonText = 'OK, MY BAD', secButtonText = null, secButtonAction = null) {
            const alertText = customAlert.querySelector('.comic-alert-text');
            const alertTitle = customAlert.querySelector('.comic-alert-title');
            const alertButton = document.getElementById('mainAlertBtn');
            const secButton = document.getElementById('secondaryAlertBtn');

            alertText.textContent = message;
            alertTitle.textContent = title;
            alertButton.textContent = buttonText;

            // Secondary Button Logic
            if (secButtonText && secButtonAction) {
                secButton.textContent = secButtonText;
                secButton.style.display = 'block';
                secButton.onclick = () => {
                    alertButton.onclick = closeAlert; // Reset main button
                    secButton.onclick = null; // Clean up
                    closeAlert();
                    secButtonAction();
                };
            }

            customAlert.style.display = 'flex';
        }

        function closeAlert() {
            customAlert.style.display = 'none';

            // Auto-open vibe selection after closing category prompt
            const alertText = document.querySelector('.comic-alert-text').textContent;
            if (alertText.includes("WHAT YOU'RE WEARING")) {
                if (window.innerWidth <= 600) {
                    // Mobile: open the popup
                    openVibePopup();
                } else {
                    // Desktop: focus and open the dropdown
                    const vibeSelector = document.getElementById('vibeSelector');
                    if (vibeSelector) {
                        vibeSelector.focus();
                        // Use showPicker() to open the dropdown (modern browsers)
                        if (vibeSelector.showPicker) {
                            vibeSelector.showPicker();
                        }
                    }
                }
            }
        }

        function navigateToProfile() {
            const link = document.getElementById('profileLink').getAttribute('href');
            if (link && link !== '#' && link !== '') {
                window.location.href = link;
            } else {
                console.log("Profile URL not ready yet...");
                // Optional: show small toast or just wait
            }
        }

        // Mobile Popup Functions
        let mobileVibeValue = '';
        let mobileTimerValue = '3';

        function openVibePopup() {
            document.getElementById('vibePopup').style.display = 'flex';
        }

        function closeVibePopup() {
            document.getElementById('vibePopup').style.display = 'none';
        }

        function selectMobileVibe(value, text) {
            mobileVibeValue = value;
            // Extract just emoji and short name for button display
            const shortText = text.split('(')[0].trim(); // e.g., "üß¢ Daily Edit"
            document.getElementById('mobileVibeText').textContent = shortText;
            closeVibePopup();
        }

        function openTimerPopup() {
            document.getElementById('timerPopup').style.display = 'flex';
        }

        function closeTimerPopup() {
            document.getElementById('timerPopup').style.display = 'none';
        }

        function selectMobileTimer(value, text) {
            mobileTimerValue = value;
            document.getElementById('mobileTimerText').textContent = text;
            closeTimerPopup();
        }

        // Custom Dropdown Logic (Removed)

        // Close dropdown when clicking outside (Removed)

        function scanOutfit() {
            stopAudio(); // Stop any playing audio before new scan logic
            // Check screen size and use appropriate selector
            let selectedVibe, timerVal;

            if (window.innerWidth <= 600) {
                // Mobile: use popup values
                selectedVibe = mobileVibeValue;
                timerVal = mobileTimerValue;

                if (!selectedVibe) {
                    // Show Alert if empty
                    showCustomAlert("TELL THE MIRROR WHAT YOU'RE WEARING SO WE CAN JUDGE YOU FAIRLY!");
                    return;
                }
            } else {
                // Desktop: use dropdown selectors
                selectedVibe = document.getElementById('vibeSelector').value;
                timerVal = document.getElementById('timerSelector').value;

                if (!selectedVibe) {
                    // Show Alert if empty
                    showCustomAlert("TELL THE MIRROR WHAT YOU'RE WEARING SO WE CAN JUDGE YOU FAIRLY!");
                    return;
                }
            }


            // Check if camera is active or file is uploaded
            const isCameraActive = video.srcObject && video.srcObject.active;
            if (!uploadedFile && !isCameraActive) {
                // No image source available
                showCustomAlert('HOLD UP! UPLOAD A PICTURE OR START THE CAMERA FIRST!');
                return;
            }

            // Proceed with scan...
            const countdownOverlay = document.getElementById('countdownOverlay');

            // If we have an uploaded file, skip countdown
            if (uploadedFile) {
                performScan();
                return;
            }

            // Normal Camera Scan Flow
            scanBtn.disabled = true;

            // Hide Camera Switch Button & Back Button during scan
            document.getElementById('cameraSwitchBtn').style.display = 'none';
            document.getElementById('backToStartBtn').style.display = 'none';

            // Start Countdown
            let timeLeft = parseInt(timerVal);
            countdownOverlay.innerText = timeLeft;
            countdownOverlay.style.display = 'block';

            const timerInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft > 0) {
                    countdownOverlay.innerText = timeLeft;
                } else {
                    clearInterval(timerInterval);
                    countdownOverlay.style.display = 'none';
                    performScan();
                }
            }, 1000);
        }

        function performScan() {
            videoContainer.classList.add('scanning');
            loadingText.style.display = 'block';

            // Only show "Hold Still" if using Camera (no uploaded file)
            if (!uploadedFile) {
                document.getElementById('stableMsg').style.display = 'block';
            }

            // Ensure switch button is hidden (redundant safety)
            document.getElementById('cameraSwitchBtn').style.display = 'none';

            const formData = new FormData();
            const vibe = document.getElementById('vibeSelector').value;
            formData.append('category', vibe);

            if (uploadedFile) {
                // Use the uploaded file directly
                formData.append('image', uploadedFile);
                // Save the uploaded image data URL for share card
                const reader = new FileReader();
                reader.onload = function (e) {
                    scannedImageDataUrl = e.target.result;
                };
                reader.readAsDataURL(uploadedFile);
                sendRequest(formData);
            } else {
                // Capture from Canvas
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Save the captured image data URL for share card
                scannedImageDataUrl = canvas.toDataURL('image/jpeg');

                canvas.toBlob(blob => {
                    formData.append('image', blob, 'capture.jpg');
                    sendRequest(formData);
                }, 'image/jpeg');
            }
        }

        function sendRequest(formData) {
            const headers = {};
            if (authToken) {
                headers['Authorization'] = 'Bearer ' + authToken;
            }

            fetch('/roast', {
                method: 'POST',
                headers: headers,
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showResult(data);
                    } else {
                        alert("Error: " + data.message);
                        resetApp();
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Error: " + err.message); // Show actual error
                    resetApp();
                });
        }

        function showResult(data) {
            videoContainer.classList.remove('scanning');
            loadingText.style.display = 'none';
            document.getElementById('stableMsg').style.display = 'none';

            const emojiStr = data.emoji || "";
            document.getElementById('emojiDisplay').innerText = emojiStr;

            animateScore(data.score);
            roastEl.innerText = data.roast;
            document.getElementById('tipsText').innerText = data.tips || "No specific advice.";

            resultOverlay.classList.add('visible');

            // Stop camera after scan (if camera was used, not uploaded file)
            if (!uploadedFile && video.srcObject) {
                const tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }

            stopAudio(); // Ensure no overlapping audio

            if (data.audio) {
                currentAudio = new Audio("data:audio/mp3;base64," + data.audio);
                currentAudio.play().catch(e => console.log("Audio play failed:", e));
            }

            // Logic for Save Button: ALWAYS VISIBLE now
            currentScore = data.score;
            const saveBtn = document.getElementById('saveScoreBtn');
            if (saveBtn) {
                saveBtn.style.display = 'block';
                saveBtn.disabled = false;

                // Visual check: Green if logged in, maybe Yellow/Gray if not? 
                // Keeping it green to encourage clicking, alert will handle the rest.
                saveBtn.innerHTML = 'SAVE DRIP üíæ';
                saveBtn.style.background = '#4CD964';
            } else {
                console.warn("Save Button not found in DOM");
            }
        }

        let currentScore = 0;

        async function saveScore() {
            if (!currentUser) {
                showCustomAlert(
                    "SIGN IN TO SAVE AND SEE YOUR DRIP STATS! üìä",
                    "LOGIN REQUIRED üîí",
                    "LATER",
                    "SIGN IN üîë",
                    window.signInWithGoogle
                );
                return;
            }
            if (!authToken) authToken = await currentUser.getIdToken();

            const saveBtn = document.getElementById('saveScoreBtn');
            saveBtn.innerHTML = 'SAVING... ‚è≥';
            saveBtn.disabled = true;

            try {
                const response = await fetch('/api/save-score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        idToken: authToken,
                        score: currentScore
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    saveBtn.innerHTML = 'SAVED! ‚úÖ';
                    saveBtn.style.background = '#ccc';

                    showCustomAlert("STATS SAVED! KEEP GRINDING! üî•", "SAVED ‚úÖ", "LATER", "SEE STATS", () => {
                        window.location.href = '/u/' + data.username;
                    });
                    // Disable button after save
                    saveBtn.innerHTML = 'SAVED ‚úÖ';
                } else {
                    showCustomAlert("ERROR SAVING: " + data.message);
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = 'SAVE DRIP üíæ';
                }
            } catch (e) {
                console.error(e);
                showCustomAlert("NETWORK ERROR SAVING SCORE");
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'SAVE DRIP üíæ';
            }
        }

        // --- NEW: Profile Spinner Logic ---
        function setProfileLoading(isLoading) {
            const desktopSpinner = document.getElementById('profileLoadingSpinner');
            const mobileSpinner = document.getElementById('mobileProfileSpinner');
            const desktopAvatar = document.getElementById('userAvatar');
            const mobileIcon = document.getElementById('mobileProfileIcon');

            // For Desktop
            if (desktopSpinner && desktopAvatar) {
                desktopSpinner.style.display = isLoading ? 'block' : 'none';
                desktopAvatar.style.display = isLoading ? 'none' : 'block';
            }

            // For Mobile
            if (mobileSpinner && mobileIcon) {
                mobileSpinner.style.display = isLoading ? 'block' : 'none';
                mobileIcon.style.display = isLoading ? 'none' : 'block';
            }
        }

        function animateScore(target) {
            let current = 0;
            scoreEl.innerText = "0";
            const duration = 1500;
            const stepTime = 30;
            const steps = duration / stepTime;
            const increment = target / steps;

            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    current = target;
                    clearInterval(timer);
                }
                scoreEl.innerText = Math.floor(current);
            }, stepTime);
        }

        function resetApp() {
            stopAudio();
            resultOverlay.classList.remove('visible');
            scanBtn.disabled = false;
            videoContainer.classList.remove('scanning');
            loadingText.style.display = 'none';
            document.getElementById('stableMsg').style.display = 'none';
            document.getElementById('tipsText').innerText = "Loading...";

            // Hide Save Button on Reset
            const saveBtn = document.getElementById('saveScoreBtn');
            if (saveBtn) saveBtn.style.display = 'none';

            // Full Reset to Start Screen
            startScreen.style.display = 'flex';
            video.style.display = 'none'; // Hide video
            previewImage.style.display = 'none'; // Hide preview
            document.getElementById('cameraSwitchBtn').style.display = 'none'; // Hide switch button
            document.getElementById('backToStartBtn').style.display = 'none'; // Hide back button
            uploadedFile = null;

            // Optional: Stop Camera Stream to save resources
            if (video.srcObject) {
                const tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
        }
    </script>

</body>

</html>